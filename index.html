<!DOCTYPE html>

<html>
    <head>
        <meta charset = "utf-8">
        <title>bubble</title>
        <style type = "text/css">
            div{
                width: 600px;
                position: absolute;
            }

            img,input,span{
                position: relative;
            }
            span{
                position: relative;
                width:40px;
                display: inline-block;
                
            }
            
            


        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
        <script src = "https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.js"></script>
        <script>

            var FUNDS = 10000000;
            var DAYNUMBER;
            var STOCKNUMBER = 10;
            var QTSTYPE = 2; //QTS 0, GQTS 1, GNQTS
            var RUNTIMES;
            var DELTA;
            var COMPANYNUMBER;
            var company_name = [];
            var s_company = [];
            var data;
            var bar_chart;
            var line_chart;
            var best_line_chart;
            var ctx;
            var ctx2;
            var ctx3;
            var box;

            function STOCK(){
                this.data = [];
                this.investment_number = [];
                this.company_name = "",
                this.totalMoney = [];
                this.fs = [];
                this.locate = [];
                this.dMoney = 0;
                this.myMoney = 0;
                this.counter = 0;
                this.mx = 0;
                this.my = 1;
                this.m = 0;
                this.daily_risk = 0;
                this.trend = 0;
                this.day = 0;
                this.Y = 0;
                this.y_line = [];
                this.Y_line = function(){
                    this.Y = this.m * this.day + FUNDS;
                    this.y_line.push(this.Y);
                };
                this.init = function(){
                    for(var j = 0; j < this.counter; j++){
                        this.fs[j] = [];
                    }
                    for(var j = 0; j < DAYNUMBER; j++){
                        this.totalMoney[j] = 0;
                    }
                }
            };





            function countTrend(stock){
                
                for(var j = 0; j < stock.length; j++){
                    if(stock[j].counter!=0){
                        stock[j].dMoney = Math.floor(FUNDS / stock[j].counter);
                        stock[j].myMoney += FUNDS % stock[j].counter;
                    }

                    for(var k = 0; k < stock[j].counter; k++){
                        stock[j].investment_number[k] = Math.floor(stock[j].dMoney / parseFloat(data[1][s_company[stock[j].locate[k]]]));
                        stock[j].myMoney += stock[j].dMoney - (stock[j].investment_number[k] * parseFloat(data[1][s_company[stock[j].locate[k]]]));
                        stock[j].fs[k][0] = stock[j].investment_number[k] * parseFloat(data[1][s_company[stock[j].locate[k]]]);    
                    }
                    
                    stock[j].totalMoney[0] = FUNDS;
                }
                
                
                for(var j = 0; j < DAYNUMBER-1; j++){
                    for(var k = 0; k < stock.length; k++){
                        for(var h = 0; h < stock[k].counter; h++){
                            
                            stock[k].totalMoney[j+1] += stock[k].investment_number[h] * parseFloat(data[j+2][s_company[stock[k].locate[h]]]);
                            stock[k].fs[h][j+1] = stock[k].investment_number[h] * parseFloat(data[j+2][s_company[stock[k].locate[h]]]);
                        }
                        stock[k].totalMoney[j+1] += stock[k].myMoney;
                        stock[k].mx += (j+2) * (stock[k].totalMoney[j+1] - FUNDS);
                        stock[k].my += (j+2) * (j+2);
                    }
                }

                for(var j = 0; j < stock.length; j++){
                    if(stock[j].counter!=0){
                        stock[j].m = stock[j].mx / stock[j].my;
                    }
                    
                    for (var k = 0; k < DAYNUMBER; k++){
                        stock[j].day = k+1;
                        stock[j].Y_line();
                        stock[j].daily_risk += (stock[j].totalMoney[k] - stock[j].Y) * (stock[j].totalMoney[k] - stock[j].Y);
                    }
                    stock[j].daily_risk = Math.sqrt(stock[j].daily_risk / DAYNUMBER);
                    if(stock[j].m < 0){
                        stock[j].trend = stock[j].m * stock[j].daily_risk;    
                    }else{
                        stock[j].trend = stock[j].m / stock[j].daily_risk;
                    }
                    
                }

                
                
                return stock;
            }

            function countFunds(){

                QTSTYPE = document.getElementById("qts_list").value;
                DELTA = parseFloat(document.getElementById("delta").value);
                RUNTIMES = parseInt(document.getElementById("runtimes").value);
                
                var c = 0;

                for(var j = 0; j < box.length; j++){
                    if(box[j].checked){
                        s_company[c] = parseInt(box[j].value);
                        c++;
                    }
                }
                COMPANYNUMBER = c;


                
                d3.csv("data3.csv", function(d) {
                    data = d;
                    DAYNUMBER = data.length - 1;

                    var stock = [];
            

                    for(var j = 0;j < COMPANYNUMBER; j++){
                        company_name[j] = data[0][s_company[j]];
                    }

                    for(var j = 0; j < COMPANYNUMBER; j++){
                        stock[j] = new STOCK();

                        for(var k = 0; k < COMPANYNUMBER; k++){
                            if(k != j){
                                stock[j].data[k] = 0;
                            }else{
                                if(stock[j].counter != 0){
                                    stock[j].company_name += ", ";
                                }
                                stock[j].data[k] = 1;
                                stock[j].company_name += company_name[k];
                                stock[j].locate[stock[j].counter] = k;
                                stock[j].counter++;
                            }
                        }
                        stock[j].init();
                    }

                    stock = countTrend(stock);

                    var best_answer = new STOCK();

                    var worst_answer = new STOCK();

                    best_answer.trend = 0;

                    for(var j = 0; j < COMPANYNUMBER; j++){
                        best_answer.data[j] = 0;
                    }
                    worst_answer.trend = 10000;

                    var change_number = [];
                    for(var j = 0; j < COMPANYNUMBER; j++){
                        change_number[j] = 0.5;
                    }
                    
                    for(var i = 0; i < RUNTIMES; i++){
                        for(var j = 0; j< COMPANYNUMBER; j++){
                            change_number[j] = Math.floor(change_number[j] * 1000) / 1000;
                        }
                        
                        var r_stock = [];
                
                        for(var j = 0; j < STOCKNUMBER; j++){
                            r_stock[j] = new STOCK();

                            for(var k = 0; k < DAYNUMBER; k++){
                                r_stock[j].totalMoney[k] = 0;
                            }

                            for(var k = 0; k < COMPANYNUMBER; k++){
                                var r = Math.random();

                                if(r > change_number[k]){
                                    r_stock[j].data[k] = 0;
                                }else{
                                    r_stock[j].data[k] = 1;
                                    if(r_stock[j].counter != 0){
                                        r_stock[j].company_name += ", ";
                                    }
                                    r_stock[j].company_name += company_name[k];
                                    r_stock[j].locate[r_stock[j].counter] = k;
                                    r_stock[j].counter++;
                                }
                            }
                            r_stock[j].init();
                        }

                        

                        r_stock = countTrend(r_stock);


                        var good_answer = r_stock[0];
                        var bad_answer = r_stock[r_stock.length-1];
                        for(var j = 0; j < STOCKNUMBER; j++){
                            if(good_answer.trend < r_stock[j].trend){
                                good_answer = r_stock[j];
                            }else if(bad_answer > r_stock[j].trend){
                                bad_answer = r_stock[j];
                            }
                        }

                        if(best_answer.trend < good_answer.trend){
                            
                            best_answer = good_answer;
                            console.log("i = ", i);
                            console.log(best_answer.counter);
                            console.log(best_answer.trend);
                        }
                        
                        if(worst_answer.trend > bad_answer.trend){
                            worst_answer = bad_answer;
                        }

                        for(var j = 0; j < COMPANYNUMBER; j++){
                            
                            switch(QTSTYPE){
                                case "QTS":
                                    if(good_answer.data[j] > bad_answer.data[j]){
                                        change_number[j] += DELTA;
                                    }else if(good_answer.data[j] < bad_answer.data[j]){
                                        change_number[j] -= DELTA;
                                    }
                                    break;
                                
                                case "GQTS":
                                    if(best_answer.data[j] > bad_answer.data[j]){
                                        change_number[j] += DELTA;
                                    }else if(best_answer.data[j] < bad_answer.data[j]){
                                        change_number[j] -= DELTA;
                                    }
                                    break;
                                
                                case "GNQTS":
                                    if(best_answer.data[j] > bad_answer.data[j]){
                                        if(change_number[j] < 0.5){
                                            change_number[j] = 1 - change_number[j];
                                        }
                                        change_number[j] += DELTA;
                                    }else if(best_answer.data[j] < bad_answer.data[j]){
                                        if(change_number[j] > 0.5){
                                            change_number[j] = 1 - change_number[j];
                                        }
                                        change_number[j] -= DELTA;
                                    }
                                    break;
                            }
                            
                        }   

                    }

                    console.log(best_answer);
                    

                    var best_name = "";
                    for(var j = 0; j < best_answer.counter; j++){
                        best_name += company_name[best_answer.locate[j]];
                        best_name += ", ";
                    }
                    
                    var day_label = [];
                    for(var j = 0; j < DAYNUMBER; j++){
                        day_label.push("day "+(j+1));
                    }



                    var color = getRandomColor();

                    var dataset = [];
                    for(var j = 0; j < COMPANYNUMBER; j++){
                        color = getRandomColor();
                        dataset.push({
                            label : stock[j].company_name,
                            borderDash: [5, 5],
                            lineTension : 0,
                            backgroundColor : color,
                            borderColor : color,
                            borderWidth : 1,
                            data: stock[j].totalMoney,
                            fill : false,
                        });
                    } 

                    color = getRandomColor();

                    

                    dataset.push({
                        label : "best : " + best_answer.company_name,
                            lineTension : 0,
                            backgroundColor : color,
                            borderColor : color,
                            borderWidth : 3,
                            data: best_answer.totalMoney,
                            fill : false,
                    });

                    color = getRandomColor();

                    dataset.push({
                        label : "趨勢線",
                            lineTension : 0,
                            backgroundColor : color,
                            borderColor : color,
                            borderWidth : 1,
                            data: best_answer.y_line,
                            fill : true,
                    });



                    color = getRandomColor();



                    var lineChartData = {
                        labels: day_label,
                        datasets: dataset,
                    }

                    stock = quickSort(stock);
                    stock.reverse();
                    var neg_stock = [];

                    for(var j = 0; j < COMPANYNUMBER; j++){
                        if(stock[stock.length - 1].trend < 0){
                            neg_stock.push(stock.pop());
                        }
                    }

                    neg_stock.reverse();

                    var dataset2 = [];
                    for(var j = 0; j < stock.length; j++){
                        color = getRandomColor();
                        dataset2.push({
                            label : stock[j].company_name,
                            backgroundColor : color,
                            borderColor : color,
                            borderWidth : 1,
                            data: [stock[j].trend],
                            yAxisID: 'y-axis-1',
                        });
                    } 

                    for(var j = 0; j < neg_stock.length; j++){
                        color = getRandomColor();
                        dataset2.push({
                            label : neg_stock[j].company_name,
                            backgroundColor : color,
                            borderColor : color,
                            borderWidth : 1,
                            data: [neg_stock[j].trend],
                            yAxisID: 'y-axis-2',
                        });
                    } 

                    
                    color = getRandomColor();
                    dataset2.push({
                        label : "best : " + best_answer.company_name,
                        backgroundColor : color,
                        borderColor : color,
                        borderWidth : 1,
                        data: [best_answer.trend],
                        yAxisID: 'y-axis-1',
                    });

                    
                    var barChartData = {
                        datasets: dataset2,
                    };

                    var dataset3 = [];

                    for(var j = 0; j < best_answer.counter; j++){
                        color = getRandomColor();
                        dataset3.push({
                            label : company_name[best_answer.locate[j]],
                            borderDash: [5, 5],
                            lineTension : 0,
                            backgroundColor : color,
                            borderColor : color,
                            borderWidth : 1,
                            data: best_answer.fs[j],
                            fill : false,
                            yAxisID: 'y-axis-1',
                        });
                    } 

                    color = getRandomColor();
                    dataset3.push({
                            label : "best : " + best_answer.company_name,
                            lineTension : 0.4,
                            backgroundColor : color,
                            borderColor : color,
                            borderWidth : 3,
                            data: best_answer.totalMoney,
                            fill : false,
                            yAxisID: 'y-axis-2',
                        });

                    var bestLineChartData = {
                        labels: day_label,
                        datasets: dataset3,
                    }

                    

                    
                    line_chart.destroy();
                    line_chart = new Chart(ctx,{
                        type: 'line',
                            data: lineChartData,
                            options: {
                                responsive: true,
                                legend:{
                                    display: true,
                                },
                                tooltips: {
                                    enabled: true
                                },
                                scales: {
                                    xAxes: [{
                                        display: true
                                    }],
                                    yAxes: [{
                                        display: true
                                    }]
                                },
                            }
                    });


                    
                    best_line_chart.destroy();
                    best_line_chart = new Chart(ctx3,{
                        type: 'line',
                            data: bestLineChartData,
                            options: {
                                responsive: true,
                                legend:{
                                    display: true,
                                },
                                tooltips: {
                                    enabled: true
                                },
                                scales: {
                                    xAxes: [{
                                        display: true
                                    }],
                                    yAxes: [{
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        id: 'y-axis-1',
                                    }, {
                                        type: 'linear', 
                                        display: true,
                                        position: 'right',
                                        id: 'y-axis-2',

                                        // grid line settings
                                        gridLines: {
                                            drawOnChartArea: false, // only want the grid lines for one axis to show up
                                        },
                                    }]
                                },

                            }
                    });

                     bar_chart.destroy();

                     bar_chart = new Chart(ctx2,{
                        type: 'bar',
                        data: barChartData,
                        options: {
                            responsive: true,
                            legend: {
                                position: 'top',
                            },
                            scales: {
                                    xAxes: [{
                                        display: true
                                    }],
                                    yAxes: [{
                                        type: 'linear',
                                        display: true,
                                        position: 'left',
                                        ticks: {
                                            min: -3,
                                            max: 3,
                                        },
                                        id: 'y-axis-1',
                                    }, {
                                        type: 'linear', 
                                        display: true,
                                        position: 'right',
                                        ticks: {
                                            min: -1500000000,
                                            max: 1500000000,
                                        },
                                        id: 'y-axis-2',
                                        // grid line settings
                                        gridLines: {
                                            drawOnChartArea: false, // only want the grid lines for one axis to show up
                                        },
                                    }]
                                },

                        }
                    });
                });
                
            }

            function quickSort(arr) {
                
                if (arr.length <= 1) {
                    return arr;
                }

                const less = [];
                const greater = [];
                const pivot = arr[arr.length - 1];
                for (let i = 0; i < arr.length - 1; ++i) {
                    const num = arr[i];
                    if (num.trend < pivot.trend) {
                    less.push(num);
                    } else {
                    greater.push(num);
                    }
                }

                return [...quickSort(less), pivot, ...quickSort(greater)];
            }

            function selectALL(){
                for(var j = 0; j < box.length; j++){
                    box[j].checked = true;
                }
            }

            function resetAll(){
                for(var j = 0; j < box.length; j++){
                    box[j].checked = false;
                }
            }

            function setAll(){
                var n = parseInt(document.getElementById("select_number").value);
                for(var j = 0; j < n; j++){
                    box[j].checked = true;
                }
            }


            function start(){       
                var sendButton = document.getElementById("sendButton");
                sendButton.addEventListener("click", countFunds, false);
                var allButton = document.getElementById("allButton");
                allButton.addEventListener("click", selectALL, false);
                var resetButton = document.getElementById("resetButton");
                resetButton.addEventListener("click", resetAll, false);
                var setButton = document.getElementById("setButton");
                setButton.addEventListener("click", setAll, false);

                
                box =document.getElementsByName("box");
                ctx = document.getElementById("canvas").getContext("2d");
                ctx2 = document.getElementById('canvas2').getContext('2d');
                ctx3 = document.getElementById('canvas3').getContext('2d');
                line_chart = new Chart(ctx,{});
                bar_chart = new Chart(ctx2,{})
                best_line_chart = bar_chart = new Chart(ctx2,{});
            
            }
            function getRandomColor() {
                var letters = '0123456789ABCDEF'.split('');
                var color = '#';
                for (var i = 0; i < 6; i++ ) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            }



            

            window.addEventListener("load", start, false);
            
                

            
        </script>
    </head>

    <body>
        <div>
            <input type = "checkbox"  value = "0" name = "box">
            <span>AAPL</span>
            <input type = "checkbox"  value = "1" name = "box">
            <span>AXP</span>
            <input type = "checkbox"  value = "2" name = "box">
            <span>BA</span>
            <input type = "checkbox"  value = "3" name = "box">
            <span>CAT</span>
            <input type = "checkbox"  value = "4" name = "box">
            <span>CSCO</span>
            <br>
            <input type = "checkbox"  value = "5" name = "box">
            <span>CVX</span>
            <input type = "checkbox"  value = "6" name = "box">
            <span>DIS</span>
            <input type = "checkbox"  value = "7" name = "box">
            <span>DD</span>
            <input type = "checkbox" value = "8" name = "box">
            <span>GS</span>
            <input type = "checkbox" value = "9" name = "box">
            <span>HD</span>
            <br>
            <input type = "checkbox" value = "10" name = "box">
            <span>IBM</span>
            <input type = "checkbox"  value = "11" name = "box">
            <span>INTC</span>
            <input type = "checkbox"  value = "12" name = "box">
            <span>JNJ</span>
            <input type = "checkbox"  value = "13" name = "box">
            <span>JPM</span>
            <input type = "checkbox"  value = "14" name = "box">
            <span>KO</span>
            <br>
            <input type = "checkbox"  value = "15" name = "box">
            <span>MCD</span>
            <input type = "checkbox"  value = "16" name = "box">
            <span>MMM</span>
            <input type = "checkbox"  value = "17" name = "box">
            <span>MRK</span>
            <input type = "checkbox"  value = "18" name = "box">
            <span>MSFT</span>
            <input type = "checkbox"  value = "19" name = "box">
            <span>NKE</span>
            <br>
            <input type = "checkbox"  value = "20" name = "box">
            <span>PFE</span>
            <input type = "checkbox"  value = "21" name = "box">
            <span>PG</span>
            <input type = "checkbox"  value = "22" name = "box">
            <span>TRV</span>
            <input type = "checkbox"  value = "23" name = "box">
            <span>UNH</span>
            <input type = "checkbox"  value = "24" name = "box">
            <span>UTX</span>
            <br>
            <input type = "checkbox"  value = "25" name = "box">
            <span>V</span>
            <input type = "checkbox"  value = "26" name = "box">
            <span>VZ</span>
            <input type = "checkbox"  value = "27" name = "box">
            <span>WBA</span>
            <input type = "checkbox"  value = "28" name = "box">
            <span>WMT</span>
            <input type = "checkbox"  value = "29" name = "box">
            <span>XOM</span>
            <br>
            
            <input type = "button" value="重設" id = "resetButton">
            <input type = "button" value="全選" id = "allButton">
            選前
            <input type = "text" value="10" id = "select_number">
            檔
            <input type = "button" value="Set" id = "setButton">
            <br>
            旋轉角度
            <input type = "text" value="0.0004" id = "delta">
            執行次數
            <input type = "text" value="10000" id = "runtimes">
            <br>
            <select name = "qts" id = "qts_list">
                <option value = "QTS">QTS</option>
                <option value = "GQTS">GQTS</option>
                <option value = "GNQTS" selected>GNQTS</option>
            </select>
            <input type = "button" value="送出" id = "sendButton">


     

        
        
        </div>


        <div style = "top: 250px" id = "div2">
            <canvas id = "canvas" width="800" height="600"></canvas>
        </div>

        <div style = "top: 250px; left:650px" id = "div3">
            <canvas id = "canvas2" width="800" height="600"></canvas>
        </div>

        <div style = "top: 750px" id = "div4">
            <canvas id = "canvas3" width="800" height="600"></canvas>
        </div>


    </body>


</html>
